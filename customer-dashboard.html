<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Dashboard - ZippyBook</title>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/themes.css">
    <link rel="stylesheet" href="css/customer-dashboard.css">
    <link rel="icon" type="image/svg+xml" href="images/zippy-icon.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo" style="display: flex; align-items: center; justify-content: center;">
                <img src="images/zippy-icon.svg" alt="ZippyBook Logo" class="logo-img" style="width: 48px; height: 48px; margin-right: 10px; object-fit: contain;">
                <h1 class="logo-text" style="margin: 0; font-size: 1.9rem; font-weight: 700; background: linear-gradient(135deg, #6366f1, #22d3ee); -webkit-background-clip: text; background-clip: text; color: transparent;">ZippyBook</h1>
            </div>
            <nav class="main-nav">
                <button class="menu-toggle" aria-label="Toggle menu">
                    <span class="hamburger"></span>
                </button>
                <ul class="nav-list">
                    <li class="nav-item"><a href="index.html#home" class="nav-link">Home</a></li>
                    <li class="nav-item"><a href="index.html#explore" class="nav-link">Explore</a></li>
                    <li class="nav-item"><a href="index.html#bookings" class="nav-link">My Bookings</a></li>
                    <!-- Account dropdown (aligned with index.html) -->
                    <li class="nav-item nav-dropdown" id="accountDropdown">
                        <a href="#" class="nav-link dropdown-toggle" aria-haspopup="true" aria-expanded="false">
                            <span class="guest-only"><i class="fas fa-user-circle"></i> Account</span>
                            <span class="auth-only">
                                <img src="images/default-avatar.svg" alt="User" class="avatar-small">
                                <span class="username">My Account</span>
                            </span>
                            <i class="fas fa-chevron-down dropdown-caret"></i>
                        </a>
                        <ul class="dropdown-menu">
                            <li class="guest-only"><a href="index.html#home" id="nav-login"><i class="fas fa-sign-in-alt"></i> Login</a></li>
                            <li class="guest-only"><a href="index.html#home" id="nav-signup"><i class="fas fa-user-plus"></i> Sign Up</a></li>
                            <li class="auth-only"><a href="index.html#account"><i class="fas fa-user-cog"></i> My Profile</a></li>
                            <li class="auth-only"><a href="index.html#bookings"><i class="fas fa-calendar-check"></i> My Bookings</a></li>
                            <li class="auth-only menu-divider"></li>
                            <li class="auth-only"><a href="#" id="nav-logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
            <!-- user-actions avatar dropdown removed; using nav dropdown above for consistency -->
        </header>

        <!-- Main Content Area -->
        <main class="main-content">
            <div class="dashboard-container">
                <header class="dashboard-header">
                    <div class="profile-summary">
                        <img src="images/default-avatar.svg" alt="User" class="profile-avatar">
                        <div>
                            <h1 class="welcome-message">Welcome back, <span id="customer-name">Omar</span>!</h1>
                            <p class="header-subtitle">Here's what's new with your account.</p>
                        </div>
                    </div>
                </header>

                <section class="dashboard-metrics">
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-calendar-check"></i></div>
                        <div class="metric-info">
                            <span class="metric-value">3</span>
                            <span class="metric-label">Upcoming Bookings</span>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-heart"></i></div>
                        <div class="metric-info">
                            <span class="metric-value">8</span>
                            <span class="metric-label">Favorites</span>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-star"></i></div>
                        <div class="metric-info">
                            <span class="metric-value">1,250</span>
                            <span class="metric-label">Reward Points</span>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-bell"></i></div>
                        <div class="metric-info">
                            <span class="metric-value">2</span>
                            <span class="metric-label">Notifications</span>
                        </div>
                    </div>
                </section>

                <div class="dashboard-main-grid">
                    <div class="dashboard-main-content">
                        <section class="dashboard-section" id="recent-bookings">
                            <div class="section-header">
                                <h2>Recent Bookings</h2>
                                <a href="index.html#bookings" class="btn btn-outline btn-sm">View All</a>
                            </div>
                            <div class="booking-list">
                                <!-- Booking items will be dynamically inserted here -->
                            </div>
                        </section>

                        <section class="dashboard-section" id="favorite-providers">
                            <div class="section-header">
                                <h2>Your Favorite Providers</h2>
                                <a href="#" class="btn btn-outline btn-sm">View All</a>
                            </div>
                            <div class="provider-list">
                                <!-- Favorite providers will be dynamically inserted here -->
                            </div>
                        </section>
                    </div>

                    <aside class="dashboard-sidebar">
                        <section class="dashboard-section" id="quick-actions">
                            <h2>Quick Actions</h2>
                            <div class="quick-actions-list">
                                <a href="index.html#explore" class="action-item">
                                    <i class="fas fa-search"></i>
                                    <span>Find a Service</span>
                                </a>
                                <a href="index.html#account" class="action-item">
                                    <i class="fas fa-user-cog"></i>
                                    <span>Manage Profile</span>
                                </a>
                                <a href="#" class="action-item">
                                    <i class="fas fa-headset"></i>
                                    <span>Contact Support</span>
                                </a>
                            </div>
                        </section>
                        <section class="dashboard-section" id="rewards-spotlight">
                            <h2>Rewards Spotlight</h2>
                            <div class="rewards-card">
                                <div class="rewards-progress">
                                    <svg class="progress-ring" width="120" height="120">
                                        <circle class="progress-ring__circle-bg" stroke-width="8" fill="transparent" r="52" cx="60" cy="60"/>
                                        <circle class="progress-ring__circle" stroke-width="8" fill="transparent" r="52" cx="60" cy="60"/>
                                    </svg>
                                    <div class="progress-text">
                                        <span>1250</span>
                                        <small>Points</small>
                                    </div>
                                </div>
                                <p>You are <strong>750</strong> points away from a $10 voucher!</p>
                                <button class="btn btn-primary btn-block">View Rewards</button>
                            </div>
                        </section>
                    </aside>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>ZippyBook</h4>
                    <p>Book services with ease, anytime, anywhere.</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul class="footer-links">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="index.html#explore">Explore</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Support</h4>
                    <ul class="footer-links">
                        <li><a href="#">Help Centre</a></li>
                        <li><a href="#">Contact Us</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 ZippyBook. All rights reserved.</p>
            </div>
        </footer>
    </div>

        <!-- Hidden file input for changing profile avatar -->
        <input type="file" id="customer-avatar-input" accept="image/*" style="display:none" />

        <script src="js/customer-dashboard.js" type="module"></script>
        <script type="module">
            // Header dropdown + mobile menu behavior to match index.html
            (function () {
                const $ = (s, c = document) => c.querySelector(s);
                const $$ = (s, c = document) => Array.from(c.querySelectorAll(s));

                // Mobile menu toggle
                const menuBtn = $('.menu-toggle');
                const navList = $('.nav-list');
                menuBtn?.addEventListener('click', () => {
                    navList?.classList.toggle('active');
                    menuBtn.classList.toggle('active');
                });

                // Account dropdown toggle
                const accountDropdown = $('#accountDropdown');
                function closeDropdown() { accountDropdown?.classList.remove('open'); }
                        accountDropdown?.addEventListener('click', (e) => {
                    const link = e.target.closest('a');
                    if (!link) return;
                    const id = link.id;
                    if (id === 'nav-logout') {
                                e.preventDefault();
                        (async () => { try { (await import('./js/supabase.js')).supabase.auth.signOut(); } catch (_) {} })();
                        try { localStorage.removeItem('userRole'); } catch (_) {}
                        try { sessionStorage.removeItem('zippybook.role'); } catch (_) {}
                        window.location.href = 'index.html';
                        return;
                    }
                    // Toggle or follow normal link
                    if (link.classList.contains('dropdown-toggle')) {
                                e.preventDefault();
                        accountDropdown.classList.toggle('open');
                    } else {
                        closeDropdown();
                                // allow normal navigation for other links
                    }
                });
                document.addEventListener('click', (e) => {
                    if (accountDropdown && !e.target.closest('#accountDropdown')) closeDropdown();
                });

                // Auth UI: fetch real name from Supabase profile/metadata
                document.body.classList.add('authenticated');
                (async () => {
                    try {
                        const mod = await import('./js/supabase.js');
                        const { supabase, fetchCurrentProfile } = mod;
                        const { data } = await supabase.auth.getUser();
                        const user = data?.user;
                        const avatars = [
                            'images/avatars/avatar-1.svg',
                            'images/avatars/avatar-2.svg',
                            'images/avatars/avatar-3.svg',
                            'images/avatars/avatar-4.svg',
                            'images/avatars/avatar-5.svg',
                            'images/avatars/avatar-6.svg',
                            'images/default-avatar.svg'
                        ];
                        const pick = () => avatars[Math.floor(Math.random() * avatars.length)];
                        const prof = await fetchCurrentProfile().catch(() => null);
                        let display = (prof?.first_name || user?.user_metadata?.first_name || '').trim();
                        const ln = (prof?.last_name || user?.user_metadata?.last_name || '').trim();
                        if (!display) display = (user?.email?.split('@')[0] || 'My Account').trim();
                        if (ln) display = `${display} ${ln}`.trim();

                        // Set header dropdown avatar/name
                        const avatarEl = accountDropdown?.querySelector('.avatar-small');
                        const usernameEl = accountDropdown?.querySelector('.username');
                        const savedAvatar = user?.user_metadata?.avatar_url || pick();
                        if (avatarEl) avatarEl.src = savedAvatar;
                        if (usernameEl) usernameEl.textContent = display;

                        // Welcome message name
                        const nameEl = document.getElementById('customer-name');
                        if (nameEl) nameEl.textContent = display.split(' ')[0] || display;

                        // Profile summary avatar on page
                        const profileAvatar = document.querySelector('.profile-summary .profile-avatar');
                        if (profileAvatar) profileAvatar.src = savedAvatar;
                    } catch (err) {
                        console.warn('Failed to load profile for header', err);
                    }
                })();

                // Make profile avatar clickable to change photo (desktop/tablet only)
                const profileAvatarEl = document.querySelector('.profile-summary .profile-avatar');
                const avatarInputEl = document.getElementById('customer-avatar-input');
                if (profileAvatarEl && avatarInputEl) {
                    const mq = window.matchMedia('(max-width: 768px)');
                    let bound = false;
                    const clickHandler = () => avatarInputEl.click();
                    const changeHandler = async (e) => {
                        const file = e.target && e.target.files && e.target.files[0];
                        if (!file) return;
                        if (!file.type || !file.type.startsWith('image/')) {
                            alert('Please select an image file.');
                            return;
                        }

                        const originalSrc = profileAvatarEl.src;
                        profileAvatarEl.style.opacity = '0.5';
                        profileAvatarEl.style.cursor = 'wait';
                        profileAvatarEl.title = 'Uploading...';

                        try {
                            const mod = await import('./js/supabase.js');
                            const { uploadProfileImage, updateProfileAvatar } = mod;
                            const avatarUrl = await uploadProfileImage(file);
                            await updateProfileAvatar(avatarUrl);
                            profileAvatarEl.src = avatarUrl;
                            const headerAvatarEl = accountDropdown?.querySelector('.avatar-small');
                            if (headerAvatarEl) headerAvatarEl.src = avatarUrl;
                            const successMsg = document.createElement('div');
                            successMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:12px 24px;border-radius:8px;z-index:1000;font-weight:500;box-shadow:0 4px 12px rgba(0,0,0,0.15);';
                            successMsg.textContent = 'Profile image updated successfully!';
                            document.body.appendChild(successMsg);
                            setTimeout(() => successMsg.remove(), 3000);
                        } catch (error) {
                            console.error('Failed to upload profile image:', error);
                            profileAvatarEl.src = originalSrc;
                            const detail = (error && (error.message || error.error_description || error.msg)) || '';
                            alert('Failed to upload profile image. ' + (detail || 'Please try again.'));
                        } finally {
                            profileAvatarEl.style.opacity = '1';
                            profileAvatarEl.style.cursor = 'pointer';
                            profileAvatarEl.title = 'Click to change photo';
                            avatarInputEl.value = '';
                        }
                    };

                    function bindUpload() {
                        if (bound) return;
                        profileAvatarEl.style.cursor = 'pointer';
                        profileAvatarEl.title = 'Click to change photo';
                        profileAvatarEl.addEventListener('click', clickHandler);
                        avatarInputEl.addEventListener('change', changeHandler);
                        bound = true;
                    }

                    function unbindUpload() {
                        if (!bound) return;
                        profileAvatarEl.removeEventListener('click', clickHandler);
                        avatarInputEl.removeEventListener('change', changeHandler);
                        profileAvatarEl.style.cursor = '';
                        profileAvatarEl.title = '';
                        bound = false;
                    }

                    // Initial bind/unbind based on viewport
                    if (mq.matches) {
                        // Mobile: do not bind
                        unbindUpload();
                    } else {
                        bindUpload();
                    }

                    // React to viewport changes
                    const onChange = (e) => {
                        if (e.matches) unbindUpload(); else bindUpload();
                    };
                    if (mq.addEventListener) mq.addEventListener('change', onChange);
                    else if (mq.addListener) mq.addListener(onChange); // older browsers
                }
            })();
        </script>
</body>
</html>
