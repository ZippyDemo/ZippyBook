<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZippyBook - Online Reservation App</title>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="icon" type="image/svg+xml" href="images/zippy-icon.svg">
    <script type="module">
        import { config } from './js/config.js';
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${config.GOOGLE_MAPS_API_KEY}&libraries=places`;
        document.head.appendChild(script);
    </script>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/google-maps.css">
    <link rel="stylesheet" href="css/themes.css">
    <link rel="stylesheet" href="css/cart.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- App Shell -->
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo" style="display: flex; align-items: center; justify-content: center;">
                <img src="images/zippy-icon.svg" alt="ZippyBook Logo" class="logo-img" style="width: 48px; height: 48px; margin-right: 10px; object-fit: contain;">
                <h1 class="logo-text" style="margin: 0; font-size: 1.9rem; font-weight: 700; background: linear-gradient(135deg, #6366f1, #22d3ee); -webkit-background-clip: text; background-clip: text; color: transparent;">ZippyBook</h1>
            </div>
            <nav class="main-nav">
                <button class="menu-toggle" aria-label="Toggle menu">
                    <span class="hamburger"></span>
                </button>
                <ul class="nav-list">
                    <li class="nav-item"><a href="#" class="nav-link active" data-page="home">Home</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-page="explore">Explore</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-page="bookings">My Bookings</a></li>
                    <li class="nav-item nav-dropdown" id="accountDropdown">
                        <a href="#" class="nav-link dropdown-toggle" aria-haspopup="true" aria-expanded="false">
                            <span class="guest-only"><i class="fas fa-user-circle"></i> Account</span>
                            <span class="auth-only">
                                <img src="images/default-avatar.svg" alt="User" class="avatar-small">
                                <span class="username">My Account</span>
                            </span>
                            <i class="fas fa-chevron-down dropdown-caret"></i>
                        </a>
                        <ul class="dropdown-menu">
                            <li class="guest-only"><a href="#" id="nav-login"><i class="fas fa-sign-in-alt"></i> Login</a></li>
                            <li class="guest-only"><a href="#" id="nav-signup"><i class="fas fa-user-plus"></i> Sign Up</a></li>
                            <li class="auth-only"><a href="#" data-page="account"><i class="fas fa-user-cog"></i> My Profile</a></li>
                            <li class="auth-only"><a href="#" data-page="bookings"><i class="fas fa-calendar-check"></i> My Bookings</a></li>
                            <li class="auth-only"><a href="#" id="nav-dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                            <li class="auth-only menu-divider"></li>
                            <li class="auth-only"><a href="#" id="nav-logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
            <div class="user-actions">
                <!-- Buttons moved to dropdown -->
                <div class="user-profile hidden">
                    <img src="images/default-avatar.svg" alt="User Profile" class="avatar">
                    <div class="dropdown-menu">
                        <a href="#" data-page="profile">My Profile</a>
                        <a href="#" data-page="bookings">My Bookings</a>
                        <a href="#" data-page="settings">Settings</a>
                        <a href="#" id="logoutBtn">Logout</a>
                        
                    </div>
                </div>
            </div>
            <button class="btn btn-back hidden" id="backBtn" aria-label="Go back" onclick="window.history.back();">
                <i class="fas fa-arrow-left"></i> Back
            </button>
        </header>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Home Page -->
            <section class="page active" id="home-page">
                <div class="hero">
                    <div class="hero-content">
                        <h2 class="hero-title">Book Services with Ease</h2>
                        <p class="hero-subtitle">Restaurants, Salons, Hotels, and more</p>
                        <div class="search-container">
                            <div class="search-box">
                                <input type="text" placeholder="What are you looking for?" class="search-input" id="search-input">
                                <button class="search-btn"><i class="fas fa-search"></i></button>
                            </div>
                            <div class="location-box">
                                <input type="text" placeholder="Enter location" class="location-input" id="location-input">
                                <button class="location-btn" id="current-location-btn"><i class="fas fa-map-marker-alt"></i></button>
                            </div>
                            <div class="filter-options">
                                <button class="filter-btn" data-category="restaurants">
                                    <i class="fas fa-utensils" style="color:#f43f5e"></i>
                                    <span>Restaurants</span>
                                    <div class="sub-options">
                                        <label class="delivery-toggle">
                                            <input type="checkbox" id="delivery-toggle">
                                            <span class="toggle-label"><i class="fas fa-motorcycle"></i> Delivery</span>
                                        </label>
                                    </div>
                                </button>
                                <button class="filter-btn" data-category="salons">
                                    <i class="fas fa-cut" style="color:#22d3ee"></i>
                                    <span>Salons</span>
                                </button>
                                <button class="filter-btn" data-category="hotels">
                                    <i class="fas fa-hotel" style="color:#8b5cf6"></i>
                                    <span>Hotels</span>
                                </button>
                                <button class="filter-btn" data-category="transport">
                                    <i class="fas fa-car" style="color:#f59e0b"></i>
                                    <span>Transport</span>
                                </button>
                                <button class="filter-btn" data-category="health">
                                    <i class="fas fa-heartbeat" style="color:#10b981"></i>
                                    <span>Health</span>
                                </button>
                                <button class="filter-btn" data-category="events">
                                    <i class="fas fa-calendar-alt" style="color:#06b6d4"></i>
                                    <span>Events</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="featured-section">
                    <h3 class="section-title">Featured Businesses</h3>
                    <div class="featured-businesses-container">
                        <div class="featured-businesses-carousel">
                            <!-- Business cards will be dynamically generated -->
                        </div>
                        <div class="carousel-nav">
                            <button class="carousel-btn prev" id="prevFeaturedBtn">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="carousel-btn next" id="nextFeaturedBtn">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="carousel-indicators" id="featuredIndicators">
                            <!-- Indicators will be dynamically generated -->
                        </div>
                    </div>
                </div>

                <div class="popular-section">
                    <h3 class="section-title">Popular Near You</h3>
                    <div class="featured-businesses-container popular-businesses-container">
                        <div class="featured-businesses-carousel popular-businesses-carousel">
                            <!-- Popular near you cards will be dynamically generated -->
                        </div>
                        <div class="carousel-nav">
                            <button class="carousel-btn prev" id="prevPopularBtn">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="carousel-btn next" id="nextPopularBtn">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="carousel-indicators" id="popularIndicators">
                            <!-- Indicators will be dynamically generated -->
                        </div>
                    </div>
                </div>
                
                <div class="nearby-section">
                    <h3 class="section-title">Nearby Services</h3>
                    <div id="map-container" class="map-container">
                        <!-- Map will be dynamically generated -->
                    </div>
                    <div class="service-cards">
                        <!-- Nearby service cards will be dynamically generated -->
                    </div>
                </div>
            </section>

            <!-- Explore Page -->
            <section class="page" id="explore-page">
                <button class="btn btn-back" id="exploreBackBtn" aria-label="Go back" onclick="window.history.back();">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <div class="page-header">
                    <h2>Explore Services</h2>
                    <div class="filter-sort">
                        <button class="btn btn-filter"><i class="fas fa-filter"></i> Filter</button>
                        <select class="sort-select">
                            <option value="recommended">Recommended</option>
                            <option value="rating">Highest Rated</option>
                            <option value="price-low">Price: Low to High</option>
                            <option value="price-high">Price: High to Low</option>
                            <option value="distance">Distance: Nearest First</option>
                        </select>
                    </div>
                </div>
                <div class="explore-container">
                    <aside class="filter-sidebar">
                        <div class="filter-group">
                            <h4>Categories</h4>
                            <div class="checkbox-group">
                                <label>
                                    <input type="checkbox" value="restaurants"> Restaurants
                                    <div class="sub-filters restaurant-filters">
                                        <label class="delivery-option">
                                            <input type="checkbox" value="delivery">
                                            <i class="fas fa-motorcycle"></i> Delivery Available
                                        </label>
                                    </div>
                                </label>
                                <label><input type="checkbox" value="salons"> Salons</label>
                                <label><input type="checkbox" value="hotels"> Hotels</label>
                                <label><input type="checkbox" value="transport"> Transportation</label>
                                <label><input type="checkbox" value="health"> Health & Beauty</label>
                                <label><input type="checkbox" value="events"> Events</label>
                            </div>
                        </div>
                        <div class="filter-group">
                            <h4>Price Range</h4>
                            <div class="range-slider">
                                <input type="range" min="0" max="1000" value="500" class="price-range">
                                <div class="range-values">
                                    <span class="min-value">$0</span>
                                    <span class="max-value">$1000</span>
                                </div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <h4>Rating</h4>
                            <div class="star-filter">
                                <label><input type="checkbox" value="5"> <span class="stars">★★★★★</span></label>
                                <label><input type="checkbox" value="4"> <span class="stars">★★★★☆</span></label>
                                <label><input type="checkbox" value="3"> <span class="stars">★★★☆☆</span></label>
                                <label><input type="checkbox" value="2"> <span class="stars">★★☆☆☆</span></label>
                                <label><input type="checkbox" value="1"> <span class="stars">★☆☆☆☆</span></label>
                            </div>
                        </div>
                        <div class="filter-group">
                            <h4>Distance</h4>
                            <div class="range-slider">
                                <input type="range" min="1" max="50" value="10" class="distance-range">
                                <div class="range-values">
                                    <span class="min-value">1 km</span>
                                    <span class="max-value">50 km</span>
                                </div>
                            </div>
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-apply-filter">Apply Filters</button>
                            <button class="btn btn-reset-filter">Reset</button>
                        </div>
                    </aside>
                    <div class="service-results">
                        <div class="map-view-toggle">
                            <button class="btn btn-outline active" data-view="list"><i class="fas fa-list"></i> List View</button>
                            <button class="btn btn-outline" data-view="map"><i class="fas fa-map-marked-alt"></i> Map View</button>
                        </div>
                        <div class="view-container">
                            <div class="list-view active">
                                <div class="service-list">
                                    <!-- Service items will be dynamically generated -->
                                </div>
                            </div>
                            <div class="map-view">
                                <div id="explore-map" class="explore-map"></div>
                            </div>
                        </div>
                        <div class="pagination">
                            <button class="pagination-btn prev" disabled><i class="fas fa-chevron-left"></i></button>
                            <div class="page-numbers">
                                <button class="page-number active">1</button>
                                <button class="page-number">2</button>
                                <button class="page-number">3</button>
                                <span class="ellipsis">...</span>
                                <button class="page-number">10</button>
                            </div>
                            <button class="pagination-btn next"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- My Bookings Page -->
            <section class="page" id="bookings-page">
                <button class="btn btn-back" id="bookingsBackBtn" aria-label="Go back" onclick="window.history.back();">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <div class="page-header">
                    <h2>My Bookings</h2>
                    <div class="booking-tabs">
                        <button class="tab-btn active" data-tab="upcoming">Upcoming</button>
                        <button class="tab-btn" data-tab="past">Past</button>
                        <button class="tab-btn" data-tab="canceled">Canceled</button>
                    </div>
                </div>
                <div class="bookings-container">
                    <div class="tab-content active" id="upcoming-bookings">
                        <div class="empty-state hidden">
                            <img src="images/empty-bookings.svg" alt="No bookings">
                            <p>You don't have any upcoming bookings</p>
                            <button class="btn btn-primary">Explore Services</button>
                        </div>
                        <div class="booking-list">
                            <!-- Booking items will be dynamically generated -->
                        </div>
                    </div>
                    <div class="tab-content" id="past-bookings">
                        <div class="booking-list">
                            <!-- Past booking items will be dynamically generated -->
                        </div>
                    </div>
                    <div class="tab-content" id="canceled-bookings">
                        <div class="booking-list">
                            <!-- Canceled booking items will be dynamically generated -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Account Page -->
            <section class="page" id="account-page">
                <button class="btn btn-back" id="accountBackBtn" aria-label="Go back" onclick="window.history.back();">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <div class="page-header">
                    <h2>My Account</h2>
                </div>
                <div class="account-container">
                    <div class="account-sidebar">
                        <div class="profile-summary">
                            <div class="profile-image">
                                <img src="images/default-avatar.svg" alt="Profile Picture">
                                <button class="edit-profile-pic"><i class="fas fa-camera"></i></button>
                            </div>
                            <h3 class="profile-name">John Doe</h3>
                            <p class="profile-email">john.doe@example.com</p>
                        </div>
                        <nav class="account-nav">
                            <a href="#" class="account-nav-link active" data-section="profile">
                                <i class="fas fa-user"></i> Profile Information
                            </a>
                            <a href="#" class="account-nav-link" data-section="payment">
                                <i class="fas fa-credit-card"></i> Payment Methods
                            </a>
                            <a href="#" class="account-nav-link" data-section="notifications">
                                <i class="fas fa-bell"></i> Notifications
                            </a>
                            <a href="#" class="account-nav-link" data-section="security">
                                <i class="fas fa-lock"></i> Security
                            </a>
                            <a href="#" class="account-nav-link" data-section="preferences">
                                <i class="fas fa-cog"></i> Preferences
                            </a>
                            <a href="#" class="account-nav-link" data-section="saved-locations">
                                <i class="fas fa-map-marker-alt"></i> Saved Locations
                            </a>
                        </nav>
                    </div>
                    <div class="account-content">
                        <div class="account-section active" id="profile-section">
                            <h3>Profile Information</h3>
                            <form class="profile-form">
                                <div class="form-group">
                                    <label for="firstName">First Name</label>
                                    <input type="text" id="firstName" value="John">
                                </div>
                                <div class="form-group">
                                    <label for="lastName">Last Name</label>
                                    <input type="text" id="lastName" value="Doe">
                                </div>
                                <div class="form-group">
                                    <label for="email">Email</label>
                                    <input type="email" id="email" value="john.doe@example.com">
                                </div>
                                <div class="form-group">
                                    <label for="phone">Phone Number</label>
                                    <input type="tel" id="phone" value="+1 (555) 123-4567">
                                </div>
                                <div class="form-group">
                                    <label for="address">Address</label>
                                    <textarea id="address">123 Main St, Anytown, USA</textarea>
                                </div>
                                <div class="form-group">
                                    <label for="userRole">Account Type</label>
                                    <select id="userRole" disabled>
                                        <option value="customer">Customer</option>
                                        <option value="business">Business Owner</option>
                                        <option value="driver">Delivery Driver</option>
                                    </select>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    
                        <!-- Payment Methods Section -->
                        <div class="account-section" id="payment-section">
                            <h3>Payment Methods</h3>
                            <div class="payment-methods-container">
                                <div class="saved-payment-methods">
                                    <h4>Saved Payment Methods</h4>
                                    <div class="payment-method-list">
                                        <div class="payment-method-item">
                                            <div class="payment-icon">
                                                <i class="fab fa-cc-visa"></i>
                                            </div>
                                            <div class="payment-details">
                                                <h5>Visa ending in 4242</h5>
                                                <p>Expires 12/25</p>
                                            </div>
                                            <div class="payment-actions">
                                                <button class="btn btn-outline btn-sm edit-payment"><i class="fas fa-edit"></i></button>
                                                <button class="btn btn-outline btn-sm delete-payment"><i class="fas fa-trash"></i></button>
                                            </div>
                                        </div>
                                        <div class="payment-method-item">
                                            <div class="payment-icon">
                                                <i class="fas fa-mobile-alt"></i>
                                            </div>
                                            <div class="payment-details">
                                                <h5>MTN Mobile Money</h5>
                                                <p>+233 XX XXX XXXX</p>
                                            </div>
                                            <div class="payment-actions">
                                                <button class="btn btn-outline btn-sm edit-payment"><i class="fas fa-edit"></i></button>
                                                <button class="btn btn-outline btn-sm delete-payment"><i class="fas fa-trash"></i></button>
                                            </div>
                                        </div>
                                        <div class="payment-method-item">
                                            <div class="payment-icon">
                                                <i class="fab fa-bitcoin"></i>
                                            </div>
                                            <div class="payment-details">
                                                <h5>Cryptocurrency</h5>
                                                <p>BTC Wallet ***789</p>
                                            </div>
                                            <div class="payment-actions">
                                                <button class="btn btn-outline btn-sm edit-payment"><i class="fas fa-edit"></i></button>
                                                <button class="btn btn-outline btn-sm delete-payment"><i class="fas fa-trash"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="add-payment-section">
                                    <h4>Add Payment Method</h4>
                                    <div class="payment-options">
                                        <button class="payment-option-btn">
                                            <i class="far fa-credit-card"></i>
                                            <span>Credit/Debit Card</span>
                                        </button>
                                        <button class="payment-option-btn">
                                            <i class="fas fa-mobile-alt"></i>
                                            <span>MTN Mobile Money</span>
                                        </button>
                                        <button class="payment-option-btn">
                                            <i class="fab fa-paypal"></i>
                                            <span>PayPal</span>
                                        </button>
                                        <button class="payment-option-btn">
                                            <i class="fab fa-apple-pay"></i>
                                            <span>Apple Pay</span>
                                        </button>
                                        <button class="payment-option-btn">
                                            <i class="fab fa-google-pay"></i>
                                            <span>Google Pay</span>
                                        </button>
                                        <div class="payment-option-wrapper">
                                            <button class="payment-option-btn" id="crypto-dropdown-btn">
                                                <i class="fab fa-bitcoin"></i>
                                                <span>Cryptocurrency</span>
                                                <i class="fas fa-chevron-down"></i>
                                            </button>
                                            <div class="crypto-submenu" id="crypto-submenu">
                                                <button class="crypto-option-btn">
                                                    <i class="fab fa-bitcoin"></i>
                                                    <span>Bitcoin (BTC)</span>
                                                </button>
                                                <button class="crypto-option-btn">
                                                    <i class="fas fa-coins"></i>
                                                    <span>Litecoin (LTC)</span>
                                                </button>
                                                <button class="crypto-option-btn">
                                                    <i class="fas fa-coins"></i>
                                                    <span>Cardano (ADA)</span>
                                                </button>
                                                <button class="crypto-option-btn">
                                                    <i class="fas fa-coins"></i>
                                                    <span>Dogecoin (DOGE)</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Saved Locations Section -->
                        <div class="account-section" id="saved-locations-section">
                            <h3>Saved Locations</h3>
                            <div class="saved-locations-container">
                                <div class="saved-location-list">
                                    <div class="saved-location-item">
                                        <div class="location-icon">
                                            <i class="fas fa-home"></i>
                                        </div>
                                        <div class="location-details">
                                            <h4>Home</h4>
                                            <p>123 Main St, Anytown, USA</p>
                                        </div>
                                        <div class="location-actions">
                                            <button class="btn btn-outline btn-sm edit-location"><i class="fas fa-edit"></i></button>
                                            <button class="btn btn-outline btn-sm delete-location"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                    <div class="saved-location-item">
                                        <div class="location-icon">
                                            <i class="fas fa-briefcase"></i>
                                        </div>
                                        <div class="location-details">
                                            <h4>Work</h4>
                                            <p>456 Office Blvd, Business City, USA</p>
                                        </div>
                                        <div class="location-actions">
                                            <button class="btn btn-outline btn-sm edit-location"><i class="fas fa-edit"></i></button>
                                            <button class="btn btn-outline btn-sm delete-location"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-primary add-location-btn">
                                    <i class="fas fa-plus"></i> Add New Location
                                </button>
                            </div>
                        </div>
                        
                        <!-- Other account sections will be added here -->
                    </div>
                </div>
            </section>
            <!-- Hidden file input for My Account avatar upload -->
            <input type="file" id="account-avatar-input" accept="image/*" style="display:none" />

            <!-- Service Detail Page -->
            <section class="page" id="service-detail-page">
                <button class="btn btn-back" id="serviceDetailBackBtn" aria-label="Go back" onclick="window.history.back();">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <!-- This will be populated dynamically when a service is selected -->
            </section>

            <!-- Booking Form Page -->
            <section class="page" id="booking-form-page">
                <button class="btn btn-back" id="bookingFormBackBtn" aria-label="Go back" onclick="window.history.back();">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <!-- This will be populated dynamically when booking a service -->
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>ZippyBook</h4>
                    <p>Book services with ease, anytime, anywhere.</p>
                    <div class="social-links">
                        <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="#" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul class="footer-links">
                        <li><a href="#">Home</a></li>
                        <li><a href="#" id="footer-explore-link">Explore</a></li>
                        <li><a href="#" id="how-it-works-link">How it Works</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Support</h4>
                    <ul class="footer-links">
                        <li><a href="#" id="help-center-link">Help Centre</a></li>
                        <li><a href="#" id="contact-us-link">Contact Us</a></li>
                        <li><a href="#" id="privacy-policy-link">Privacy Policy</a></li>
                        <li><a href="#" id="terms-of-use-link">Terms of Use</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Download App</h4>
                    <a href="#" class="app-link" aria-label="Apple">
                    <i class="fab fa-apple" aria-hidden="true" style="font-size: 28px;"></i>
                    </a>
                    <a href="#" class="app-link" aria-label="Android">
                        <i class="fab fa-android" aria-hidden="true" style="font-size: 28px;"></i>
                    </a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 ZippyBook. All rights reserved.</p>
            </div>
        </footer>

        <!-- Modals -->
        <!-- Login Modal -->
        <div class="modal" id="login-modal">
            <div class="modal-content">
                <button class="modal-close">&times;</button>
                <h2>Login</h2>
                <form class="login-form">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <div class="password-input">
                            <input type="password" id="loginPassword" required>
                            <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>
                    <div class="form-group remember-forgot">
                        <label class="checkbox-label">
                            <input type="checkbox" id="rememberMe">
                            <span class="checkbox-custom"></span>
                            Remember me
                        </label>
                        <a href="#" class="forgot-password">Forgot password?</a>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Login</button>
                    <div class="social-login">
                        <p>Or login with</p>
                        <div class="social-buttons">
                            <button type="button" class="btn btn-social btn-google">
                                <i class="fab fa-google"></i> Google
                            </button>
                            <button type="button" class="btn btn-social btn-facebook">
                                <i class="fab fa-facebook-f"></i> Facebook
                            </button>
                        </div>
                    </div>
                    <p class="switch-form">Don't have an account? <a href="#" id="switchToSignup">Sign up</a></p>
                </form>
            </div>
        </div>

        <!-- Signup Modal -->
        <div class="modal" id="signup-modal">
            <div class="modal-content">
                <button class="modal-close">&times;</button>
                <h2>Create Account</h2>
                <form class="signup-form">
                    <div class="form-group">
                        <label for="signupRole">Account Type</label>
                        <select id="signupRole" class="role-select" required>
                            <option value="">Select Account Type</option>
                            <option value="customer">Customer</option>
                            <option value="business">Business Owner</option>
                            <option value="driver">Driver</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="signupFirstName">First Name</label>
                            <input type="text" id="signupFirstName" required>
                        </div>
                        <div class="form-group">
                            <label for="signupLastName">Last Name</label>
                            <input type="text" id="signupLastName" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPhone">Phone Number</label>
                        <input type="tel" id="signupPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="signupAddress">Address</label>
                        <input type="text" id="signupAddress" placeholder="Enter your address">
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <div class="password-input">
                            <input type="password" id="signupPassword" required>
                            <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
                        </div>
                        <div class="password-strength">
                            <div class="strength-meter">
                                <div class="strength-segment"></div>
                                <div class="strength-segment"></div>
                                <div class="strength-segment"></div>
                                <div class="strength-segment"></div>
                            </div>
                            <span class="strength-text">Password strength</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="signupConfirmPassword">Confirm Password</label>
                        <div class="password-input">
                            <input type="password" id="signupConfirmPassword" required>
                            <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>
                    <div class="form-group terms-privacy">
                        <label class="checkbox-label">
                            <input type="checkbox" id="agreeTerms" required>
                            <span class="checkbox-custom"></span>
                            I agree to the <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Create Account</button>
                    <div class="social-login">
                        <p>Or sign up with</p>
                        <div class="social-buttons">
                            <button type="button" class="btn btn-social btn-google">
                                <i class="fab fa-google"></i> Google
                            </button>
                            <button type="button" class="btn btn-social btn-facebook">
                                <i class="fab fa-facebook-f"></i> Facebook
                            </button>
                        </div>
                    </div>
                    <p class="switch-form">Already have an account? <a href="#" id="switchToLogin">Login</a></p>
                </form>
            </div>
        </div>

        <!-- Add Location Modal -->
        <div class="modal" id="add-location-modal">
            <div class="modal-content">
                <button class="modal-close">&times;</button>
                <h2>Add New Location</h2>
                <form class="add-location-form">
                    <div class="form-group">
                        <label for="locationName">Location Name</label>
                        <input type="text" id="locationName" placeholder="e.g., Home, Work, Gym" required>
                    </div>
                    <div class="form-group">
                        <label for="locationAddress">Address</label>
                        <input type="text" id="locationAddress" placeholder="Enter address" required>
                    </div>
                    <div class="form-group">
                        <label>Location Type</label>
                        <div class="location-type-options">
                            <label class="location-type-option">
                                <input type="radio" name="locationType" value="home" checked>
                                <span class="location-type-icon"><i class="fas fa-home"></i></span>
                                <span class="location-type-label">Home</span>
                            </label>
                            <label class="location-type-option">
                                <input type="radio" name="locationType" value="work">
                                <span class="location-type-icon"><i class="fas fa-briefcase"></i></span>
                                <span class="location-type-label">Work</span>
                            </label>
                            <label class="location-type-option">
                                <input type="radio" name="locationType" value="favorite">
                                <span class="location-type-icon"><i class="fas fa-heart"></i></span>
                                <span class="location-type-label">Favorite</span>
                            </label>
                            <label class="location-type-option">
                                <input type="radio" name="locationType" value="other">
                                <span class="location-type-icon"><i class="fas fa-map-marker-alt"></i></span>
                                <span class="location-type-label">Other</span>
                            </label>
                        </div>
                    </div>
                    <div id="location-map-preview" class="location-map-preview"></div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" id="cancel-add-location">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Location</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Service Provider Dashboard Modal -->
        <div class="modal" id="provider-dashboard-modal">
            <div class="modal-content modal-large">
                <button class="modal-close">&times;</button>
                <h2>Service Provider Dashboard</h2>
                <div class="dashboard-tabs">
                    <button class="tab-btn active" data-tab="overview">Overview</button>
                    <button class="tab-btn" data-tab="bookings">Bookings</button>
                    <button class="tab-btn" data-tab="services">Services</button>
                    <button class="tab-btn" data-tab="calendar">Calendar</button>
                    <button class="tab-btn" data-tab="reviews">Reviews</button>
                    <button class="tab-btn" data-tab="settings">Settings</button>
                </div>
                <div class="dashboard-content">
                    <!-- Dashboard content will be dynamically loaded -->
                </div>
            </div>
        </div>

        <!-- Notification Toast -->
        <div class="toast-container">
            <!-- Notification toasts will be dynamically generated -->
        </div>

        <!-- Privacy Policy Modal -->
        <div class="modal" id="privacy-policy-modal">
            <div class="modal-content">
                <button class="modal-close">&times;</button>
                <h2>Privacy Policy for ZippyBook</h2>
                <p><strong>Effective Date:</strong> 02/01/2025</p>
                <p>Thank you for choosing ZippyBook (“we,” “our,” or “us”). Your privacy is important to us, and we are committed to protecting your personal information. This Privacy Policy describes how we collect, use, disclose, and safeguard your information when you use our online reservation app, accessible via web or mobile application (collectively, the “Service”).</p>
                <h3>1. Information We Collect</h3>
                <p>We may collect the following types of information:</p>
                <ul>
                    <li><strong>Personal Information:</strong></li>
                    <ul>
                        <li>Name</li>
                        <li>Email address</li>
                        <li>Phone number</li>
                        <li>Payment details (via secure third-party processors)</li>
                        <li>Reservation history</li>
                        <li>Location (if permitted)</li>
                    </ul>
                    <li><strong>Non-Personal Information:</strong></li>
                    <ul>
                        <li>Browser type</li>
                        <li>Device information</li>
                        <li>Operating system</li>
                        <li>IP address</li>
                        <li>Usage data and analytics</li>
                    
                </ul>
                <h3>2. How We Use Your Information</h3>
                <p>We use the information we collect to:</p>
                <ul>
                    <li>Process and manage reservations</li>
                    <li>Communicate with you about bookings or changes</li>
                    <li>Send confirmations, reminders, and promotional offers</li>
                    <li>Improve our services and user experience</li>
                    <li>Ensure security and prevent fraud</li>
                    <li>Comply with legal obligations</li>
                </ul>
                <h3>3. Sharing of Your Information</h3>
                <p>We do not sell your personal data. However, we may share your information with:</p>
                <ul>
                    <li><strong>Service Providers:</strong> For payment processing, analytics, customer support, etc.</li>
                    <li><strong>Partners:</strong> Such as restaurants, salons, or businesses where you make reservations</li>
                    <li><strong>Legal Authorities:</strong> When required to comply with legal obligations or protect rights</li>
                </ul>
                <h3>4. Data Retention</h3>
                <p>We retain your information only for as long as necessary to fulfill the purposes outlined in this policy, unless a longer retention period is required by law.</p>
                <h3>5. Your Privacy Rights</h3>
                <p>Depending on your location, you may have the right to:</p>
                <ul>
                    <li>Access the data we hold about you</li>
                    <li>Request correction or deletion of your information</li>
                    <li>Withdraw consent or object to processing</li>
                    <li>File a complaint with a data protection authority</li>
                </ul>
                <p>You can make these requests by contacting us at <a href="mailto:zippybookgh@yahoo.com">zippybookgh@yahoo.com</a>.</p>
                <h3>6. Security</h3>
                <p>We implement reasonable technical and organizational safeguards to protect your information. However, no system can be 100% secure, so we cannot guarantee absolute security.</p>
                <h3>7. Third-Party Links</h3>
                <p>Our app may contain links to external sites. We are not responsible for the privacy practices or content of those sites.</p>
                <h3>8. Children’s Privacy</h3>
                <p>Our service is not intended for individuals under the age of 13, and we do not knowingly collect data from children.</p>
                <h3>9. Changes to This Policy</h3>
                <p>We may update this Privacy Policy from time to time. If we make significant changes, we will notify you via the app or email.</p>
                <h3>10. Contact Us</h3>
                <p>If you have any questions or concerns about this Privacy Policy, please contact us at:</p>
                <p>Website: <a href="https://www.zippybook.com">www.ZippyBook.com</a><br>Email: <a href="mailto:zippybookgh@yahoo.com">zippybookgh@yahoo.com</a></p>
            </div>
        </div>

        <!-- Contact Us Modal -->
        <div class="modal" id="contact-us-modal">
            <div class="modal-content" style="max-width: 520px;">
                <button class="modal-close">&times;</button>
                <h2>📞 Contact Us</h2>
                <p>At Zippybook, we value our users and aim to provide prompt and reliable support for all inquiries.</p>

                <h3>How to Reach Us</h3>
                <ul>
                    <li><strong>In-App Support Chat</strong> – Available 24/7 for quick questions and assistance.</li>
                    <li><strong>Email Support</strong> – Contact us at <a href="mailto:zippybookgh@yahoo.com">zippybookgh@yahoo.com</a> for detailed inquiries.</li>
                    <li><strong>Help Center/FAQ</strong> – Visit our in-app FAQ section for immediate answers.</li>
                </ul>

                <h3>Response Time</h3>
                <ul>
                    <li><strong>Chat Support</strong> – Typically within 5–10 minutes.</li>
                    <li><strong>Email Support</strong> – Within 24–48 business hours.</li>
                </ul>

                <h3>User Responsibilities</h3>
                <ul>
                    <li>Provide accurate details (reservation ID, account email, or order number) for faster assistance.</li>
                    <li>Be respectful and courteous to our support team. Abusive or offensive language will not be tolerated.</li>
                </ul>

                <h3>Escalation Policy</h3>
                <p>If your concern is not resolved within the given timeframe, you may request an escalation. A senior support representative will review and follow up on your issue.</p>

                <h3>Data & Privacy</h3>
                <p>Any personal information shared during support will be handled in accordance with our Privacy Policy and will not be disclosed to unauthorized parties.</p>
            </div>
        </div>

        <!-- How It Works Modal -->
        <div class="modal" id="how-it-works-modal">
            <div class="modal-content" style="max-width: 640px;">
                <button class="modal-close">&times;</button>
                <h2>📱 How It Works</h2>
                <p>Easily book everything you need in just a few taps.</p>
                <ul class="how-it-works-list">
                    <li><strong>Create an Account / Sign In</strong> – Set up your profile to save preferences and payment details for faster checkout.</li>
                    <li><strong>Search & Explore</strong> – Use the smart search bar or Google Maps integration to find hotels, rentals, flights, cars, dining, events, and excursions near you or at your destination.</li>
                    <li><strong>Compare & Select</strong> – View prices, reviews, photos, and availability side by side before making your choice.</li>
                    <li><strong>Reserve Instantly</strong> – Secure your booking in real-time with instant confirmation.</li>
                    <li><strong>Customize Your Experience</strong> – Add dining reservations (even pre-order food 15 minutes before arrival), event tickets, or transport add-ons.</li>
                    <li><strong>Track & Manage Bookings</strong> – View all reservations in one place with easy options to modify, cancel, or reschedule.</li>
                    <li><strong>Check-In Made Simple</strong> – Use mobile check-in for hotels and rentals, and digital tickets for events, flights, and excursions.</li>
                    <li><strong>24/7 Support</strong> – Get assistance anytime through in-app chat, FAQs, or our “Contact Us” support center.</li>
                </ul>
            </div>
        </div>

        <!-- Terms of Use Modal -->
        <div class="modal" id="terms-of-use-modal">
          <div class="modal-content" style="max-width: 800px;">
            <button class="modal-close">&times;</button>
            <h2>Terms of Use</h2>
            <p><strong>Effective Date:</strong> 02/01/2025</p>
            <p>Welcome to ZIPPYBOOK (“we,” “our,” “us”). These Terms of Use (“Terms”) govern your access to and use of our mobile application, website, and related services (collectively, the “App”). By downloading, accessing, or using the App, you agree to be bound by these Terms. If you do not agree, please do not use our services.</p>

            <h3>1. Eligibility</h3>
            <ul>
              <li>You must be at least 16 years old to use our App.</li>
              <li>By using the App, you represent that all information you provide is accurate and up to date.</li>
            </ul>

            <h3>2. Services Provided</h3>
            <p>Our App allows users to:</p>
            <ul>
              <li>Reserve hotels, short-stay rentals, and vehicles.</li>
              <li>Book flights, excursions, and event tickets.</li>
              <li>Pre-order food and dine-in reservations.</li>
              <li>Search nearby services using integrated tools (e.g., Google API).</li>
            </ul>
            <p>We act as a platform to connect you with third-party providers (“Service Providers”). We do not own, operate, or control the services provided by these Service Providers.</p>

            <h3>3. User Accounts</h3>
            <ul>
              <li>You must create an account to access certain features.</li>
              <li>You are responsible for maintaining the confidentiality of your login credentials.</li>
              <li>You agree to notify us immediately of any unauthorized access or security breach.</li>
            </ul>

            <h3>4. Reservations & Payments</h3>
            <ul>
              <li>All bookings are subject to availability and acceptance by Service Providers.</li>
              <li>Prices, availability, and conditions are determined by the Service Providers and may change without notice.</li>
              <li>Payment processing may be handled by third-party payment providers. By making a reservation, you agree to comply with their terms as well.</li>
              <li>Refunds, cancellations, and changes are subject to each Service Provider’s policy.</li>
            </ul>

            <h3>5. User Responsibilities</h3>
            <p>By using our App, you agree to:</p>
            <ul>
              <li>Use the App only for lawful purposes.</li>
              <li>Not engage in fraudulent activity, including false bookings or misuse of the platform.</li>
              <li>Provide accurate personal and payment details.</li>
              <li>Respect Service Providers’ rules and policies.</li>
            </ul>

            <h3>6. Third-Party Services</h3>
            <p>The App may include links or integrations with third-party services (e.g., maps, payment processors, service listings). We are not responsible for the content, policies, or practices of these third parties.</p>

            <h3>7. Intellectual Property</h3>
            <p>All content, design, logos, and features of the App are owned by or licensed to ZIPPYBOOK. You may not copy, distribute, or modify our intellectual property without prior written consent.</p>

            <h3>8. Limitation of Liability</h3>
            <ul>
              <li>We provide the App “as is” without warranties of any kind.</li>
              <li>We are not liable for the acts, errors, omissions, or negligence of Service Providers.</li>
              <li>To the maximum extent permitted by law, we disclaim all liability for any damages resulting from your use of the App or services booked through it.</li>
            </ul>

            <h3>9. Termination</h3>
            <p>We may suspend or terminate your account and access to the App at any time if we reasonably believe you violated these Terms.</p>

            <h3>10. Changes to Terms</h3>
            <p>We reserve the right to update or modify these Terms at any time. Updates will be effective once posted within the App. Your continued use constitutes acceptance of the revised Terms.</p>
          </div>
        </div>

        <!-- Help Centre Modal -->
        <div class="modal" id="help-center-modal">
          <div class="modal-content" style="max-width: 720px;">
            <button class="modal-close">&times;</button>
            <h2>Help Centre</h2>
            <p>Welcome to the Help Centre for ZIPPYBOOK. We’re here to ensure your booking experience is smooth, simple, and stress-free.</p>

            <h3>Getting Started</h3>
            <ul>
              <li><strong>Creating an Account</strong> – Sign up using your email, phone number, or social login to get started.</li>
              <li><strong>Managing Your Profile</strong> – Update personal details, payment methods, and preferences under “My Account.”</li>
              <li><strong>Browsing Services</strong> – Use the search bar or category filters (Hotels, Rentals, Food, Events, Flights, Excursions, etc.) to explore options.</li>
            </ul>

            <h3>Making Reservations</h3>
            <ul>
              <li><strong>Booking Hotels & Rentals</strong> – Select dates, number of guests, and preferred location. Confirm instantly.</li>
              <li><strong>Food Orders & Dine-In Reservations</strong> – Order meals ahead of arrival or reserve a table in advance.</li>
              <li><strong>Events & Excursions</strong> – Secure tickets and passes with a few taps.</li>
              <li><strong>Flights & Transportation</strong> – Compare and book vehicles or flights at competitive rates.</li>
            </ul>

            <h3>Managing Reservations</h3>
            <ul>
              <li><strong>View Bookings</strong> – All confirmed reservations appear in “My Reservations.”</li>
              <li><strong>Modify or Cancel</strong> – Depending on provider policy, you can edit or cancel bookings directly through the app.</li>
              <li><strong>Notifications</strong> – Get real-time updates, reminders, and alerts about your reservations.</li>
            </ul>

            <h3>Payments & Refunds</h3>
            <ul>
              <li><strong>Accepted Payment Methods</strong> – Credit/debit cards, digital wallets, and secure in-app checkout.</li>
              <li><strong>Refund Policy</strong> – Refund eligibility depends on the partner’s cancellation policy. Details are shown before confirming a booking.</li>
              <li><strong>Receipts</strong> – Access invoices and receipts anytime under “Payment History.”</li>
            </ul>

            <h3>Troubleshooting</h3>
            <ul>
              <li><strong>App Not Loading?</strong> – Check your internet connection and update the app to the latest version.</li>
              <li><strong>Booking Didn’t Confirm?</strong> – Ensure payment went through; if not, retry or contact support.</li>
              <li><strong>Can’t Log In?</strong> – Use “Forgot Password” or reach out to us for help resetting credentials.</li>
            </ul>

            <h3>Customer Support</h3>
            <ul>
              <li><strong>Live Chat</strong> – Get real-time assistance from our support team.</li>
              <li><strong>Email Us</strong> – <a href="mailto:zippybookgh@yahoo.com">zippybookgh@yahoo.com</a> for inquiries, refunds, or feedback.</li>
            </ul>

            <h3>FAQs</h3>
            <ul>
              <li>How do I change my booking?</li>
              <li>What happens if I miss my reservation?</li>
              <li>How do refunds work?</li>
            </ul>
          </div>
        </div>

    </div>

    <!-- Templates for dynamic content -->
    <template id="service-card-template">
        <div class="service-card">
            <div class="service-image">
                <img src="" alt="">
                <div class="service-badge"></div>
            </div>
            <div class="service-info">
                <h4 class="service-name"></h4>
                <div class="service-rating">
                    <div class="stars"></div>
                    <span class="rating-count"></span>
                </div>
                <p class="service-category"></p>
                <p class="service-location"></p>
                <div class="service-price"></div>
            </div>
        </div>
    </template>

    <template id="booking-item-template">
        <div class="booking-item">
            <div class="booking-image">
                <img src="" alt="">
            </div>
            <div class="booking-details">
                <h4 class="booking-service-name"></h4>
                <div class="booking-info">
                    <p class="booking-date"></p>
                    <p class="booking-time"></p>
                    <p class="booking-guests"></p>
                </div>
                <div class="booking-status"></div>
            </div>
            <div class="booking-actions">
                <button class="btn btn-outline btn-modify">Modify</button>
                <button class="btn btn-outline btn-cancel">Cancel</button>
            </div>
        </div>
    </template>

    <!-- Scripts -->
    <script src="js/github-pages-fix.js" type="module"></script>
    <script src="js/app.js" type="module"></script>
    <script src="js/featured-businesses.js" type="module"></script>
    <script src="js/category-integration.js" type="module"></script>
    <script src="js/popular-near-you.js" type="module"></script>
    <!-- Global Cart available across the site -->
    <script src="js/cart.js" type="module"></script>
    <script src="js/provider-dashboard.js" type="module"></script>
    <script src="js/google-maps-integration.js" type="module"></script>
        <!-- Redirect to dashboards after login + deep-link support -->
    <script>
      (function () {
        function redirectToDashboardByRole(role) {
          try { sessionStorage.setItem('zippybook.role', role); } catch (_) {}
          if (role === 'business') {
            window.location.href = 'business-dashboard.html';
                    } else if (role === 'driver') {
                        window.location.href = 'driver-dashboard.html';
                    } else if (role === 'customer') {
                        window.location.href = 'customer-dashboard.html';
          }
        }

        // Deep-link support
        if (location.hash === '#business-dashboard') redirectToDashboardByRole('business');
        if (location.hash === '#delivery-dashboard') redirectToDashboardByRole('driver');
                if (location.hash === '#driver-dashboard') redirectToDashboardByRole('driver');
                if (location.hash === '#customer-dashboard') redirectToDashboardByRole('customer');

        document.addEventListener('DOMContentLoaded', function () {
          var loginModal = document.getElementById('login-modal');
          var loginForm = loginModal ? loginModal.querySelector('.login-form') : null;
          if (!loginForm) return;

                    loginForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        try {
                            var email = document.getElementById('loginEmail')?.value?.trim();
                            var password = document.getElementById('loginPassword')?.value || '';
                            var rolePick = document.getElementById('loginRole')?.value || '';
                            const mod = await import('./js/supabase.js');
                            const { signInWithEmail } = mod;
                            const { role } = await signInWithEmail({ email, password });
                            var finalRole = role || rolePick || 'customer';
                            // Persist for guards relying on localStorage
                            try { localStorage.setItem('userRole', finalRole); } catch(_) {}
                            redirectToDashboardByRole(finalRole);
                        } catch (err) {
                            console.error(err);
                            alert(err?.message || 'Login failed');
                        }
                    });
        });
      })();
    </script>

    <!-- Core wiring: routing, modals, tabs, maps, toasts -->
    <script type="module">
      const $ = (s, ctx = document) => ctx.querySelector(s);
      const $$ = (s, ctx = document) => Array.from(ctx.querySelectorAll(s));
            // Shared map instances and last-known user location within this module
            let nearMap = null, exploreMap = null, previewMap = null;
            let userLatLng = null; // { lat, lng }
            const LAST_LOC_KEY = 'zippy:lastLocation';
            function readLastLocation() {
                try { const raw = localStorage.getItem(LAST_LOC_KEY); if (!raw) return null; const obj = JSON.parse(raw); if (typeof obj?.lat === 'number' && typeof obj?.lng === 'number') return obj; } catch {} return null;
            }
            function saveLastLocation(latLng) { try { localStorage.setItem(LAST_LOC_KEY, JSON.stringify(latLng)); } catch {} }

      // SPA routing
      const pages = $$('.page');
      function goToPage(name = 'home') {
        const id = `${name}-page`;
        pages.forEach(p => p.classList.toggle('active', p.id === id));
        $$('.nav-link').forEach(a => a.classList.toggle('active', a.dataset.page === name));
        const isHome = $('#home-page')?.classList.contains('active');
        $('#backBtn')?.classList.toggle('hidden', !!isHome);
      }
      $$('.nav-link').forEach(a => {
        a.addEventListener('click', e => {
          e.preventDefault();
          if (!a.dataset.page) return; // Ignore dropdown toggle
          const page = a.dataset.page || 'home';
          goToPage(page);
          history.pushState({ page }, '', `#${page}`);
        });
      });
      window.addEventListener('popstate', e => {
        const page = (e.state && e.state.page) || (location.hash ? location.hash.slice(1) : 'home');
        goToPage(page);
      });
      goToPage(location.hash ? location.hash.slice(1) : 'home');

            // Mobile menu toggle
            const menuBtn = $('.menu-toggle');
            const navList = $('.nav-list');
            menuBtn?.addEventListener('click', () => {
                navList?.classList.toggle('active');
                menuBtn.classList.toggle('active');
            });

      // Toasts
      function notify(msg, type = 'info') {
        const c = $('.toast-container'); if (!c) return;
        const el = document.createElement('div');
        el.className = `toast ${type}`;
        el.textContent = msg;
        c.appendChild(el);
        requestAnimationFrame(() => el.classList.add('show'));
        setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 250); }, 3000);
      }

      // Modals: open/close
      function showModal(id) {
        const m = document.getElementById(id); if (!m) return;
        m.classList.add('active'); document.body.classList.add('modal-open');
      }
      function hideModal(elOrId) {
        const m = typeof elOrId === 'string' ? document.getElementById(elOrId) : elOrId;
        if (!m) return; m.classList.remove('active');
        if (!$$('.modal.active').length) document.body.classList.remove('modal-open');
      }
      $$('.modal .modal-close').forEach(btn => btn.addEventListener('click', () => hideModal(btn.closest('.modal'))));
      document.addEventListener('click', e => { const m = e.target.closest('.modal'); if (m && e.target === m) hideModal(m); });
      document.addEventListener('keydown', e => { if (e.key === 'Escape') $$('.modal.active').forEach(m => hideModal(m)); });

      // Openers
      $('#nav-login')?.addEventListener('click', (e) => { e.preventDefault(); showModal('login-modal'); });
      $('#nav-signup')?.addEventListener('click', (e) => { e.preventDefault(); showModal('signup-modal'); });
      $('#privacy-policy-link')?.addEventListener('click', e => { e.preventDefault(); showModal('privacy-policy-modal'); });
      $('#contact-us-link')?.addEventListener('click', e => { e.preventDefault(); showModal('contact-us-modal'); });
      $('#how-it-works-link')?.addEventListener('click', e => { e.preventDefault(); showModal('how-it-works-modal'); });
      $('#terms-of-use-link')?.addEventListener('click', e => { e.preventDefault(); showModal('terms-of-use-modal'); });
      $('#help-center-link')?.addEventListener('click', e => { e.preventDefault(); showModal('help-center-modal'); });

      // Switch login/signup
      $('#switchToSignup')?.addEventListener('click', e => { e.preventDefault(); hideModal('login-modal'); showModal('signup-modal'); });
      $('#switchToLogin')?.addEventListener('click', e => { e.preventDefault(); hideModal('signup-modal'); showModal('login-modal'); });

      // Password toggle
      $$('.toggle-password').forEach(btn => {
        btn.addEventListener('click', () => {
          const input = btn.parentElement?.querySelector('input');
          if (!input) return;
          const isPwd = input.type === 'password';
          input.type = isPwd ? 'text' : 'password';
          btn.innerHTML = `<i class="fas fa-${isPwd ? 'eye-slash' : 'eye'}"></i>`;
        });
      });

            // Account Dropdown
            const accountDropdown = $('#accountDropdown');
            accountDropdown?.addEventListener('click', e => {
                e.preventDefault();
                const isLink = e.target.closest('a[data-page]') || e.target.closest('a[id^="nav-"]');
                if (isLink) {
                    // Handle clicks on links inside dropdown
                    if (isLink.id === 'nav-login') showModal('login-modal');
                    else if (isLink.id === 'nav-signup') showModal('signup-modal');
                    else if (isLink.id === 'nav-dashboard') {
                        // Redirect to appropriate dashboard based on role
                        const role = (sessionStorage.getItem('zippybook.role') || localStorage.getItem('userRole') || 'customer').toLowerCase();
                        if (role === 'business') window.location.href = 'business-dashboard.html';
                        else if (role === 'driver') window.location.href = 'driver-dashboard.html';
                        else window.location.href = 'customer-dashboard.html';
                    }
                    else if (isLink.id === 'nav-logout') {
                        // Logout logic from below
                        (async () => {
                            try {
                                (await import('./js/supabase.js')).supabase.auth.signOut();
                            } catch (_) {}
                        })();
                        notify('Logged out', 'info');
                        updateAccountMenuForAuthState(false);
                        try { sessionStorage.removeItem('zippybook.role'); } catch (_) {}
                        // Ensure Provider Dashboard UI is removed on logout
                        try {
                            const btn = document.getElementById('provider-dashboard-btn');
                            if (btn) btn.remove();
                            const modal = document.getElementById('provider-dashboard-modal');
                            if (modal) {
                                modal.classList.remove('active');
                                // If no other modals are open, also clear body state
                                if (!document.querySelector('.modal.active')) {
                                    document.body.classList.remove('modal-open');
                                }
                            }
                        } catch (_) {}
                    }
                    else if (isLink.dataset.page) {
                        goToPage(isLink.dataset.page);
                        history.pushState({ page: isLink.dataset.page }, '', `#${isLink.dataset.page}`);
                    }
                    accountDropdown.classList.remove('open'); // Close dropdown after click
                } else {
                    // Toggle dropdown
                    accountDropdown.classList.toggle('open');
                }
            });
            document.addEventListener('click', e => {
                if (accountDropdown && !e.target.closest('#accountDropdown')) {
                    accountDropdown.classList.remove('open');
                }
            });

      // Auth UI
      function updateAccountMenuForAuthState(isAuth) {
          document.body.classList.toggle('authenticated', isAuth);
          if (isAuth) {
              const avatars = [
                'images/avatars/avatar-1.svg',
                'images/avatars/avatar-2.svg',
                'images/avatars/avatar-3.svg',
                'images/avatars/avatar-4.svg',
                'images/avatars/avatar-5.svg',
                'images/avatars/avatar-6.svg',
                'images/default-avatar.svg'
              ];
              const pick = () => avatars[Math.floor(Math.random() * avatars.length)];
                            const usernameEl = accountDropdown?.querySelector('.username');
                            const avatarEl = accountDropdown?.querySelector('.avatar-small');
                            (async () => {
                                try {
                                    const mod = await import('./js/supabase.js');
                                    const { supabase, fetchCurrentProfile } = mod;
                                    const { data } = await supabase.auth.getUser();
                                    const user = data?.user;
                                    let display = (user?.user_metadata?.first_name || '').trim();
                                    const last = (user?.user_metadata?.last_name || '').trim();
                                    if (!display) display = (user?.email?.split('@')[0] || '').trim();
                                    if (display && last) display = `${display} ${last}`.trim();
                                    const prof = await fetchCurrentProfile().catch(() => null);
                                    // Display name can still use prof first/last if you want, but avatar strictly from users metadata
                                    if (prof) {
                                        const fn = (prof.first_name || '').trim();
                                        const ln = (prof.last_name || '').trim();
                                        const full = `${fn} ${ln}`.trim();
                                        if (full) display = full;
                                    }
                                    const avatarUrl = user?.user_metadata?.avatar_url || null;
                                    if (usernameEl) usernameEl.textContent = display || 'My Account';
                                    if (avatarEl) avatarEl.src = avatarUrl || pick();
                                    // Sidebar summary on Account page
                                    const sideName = document.querySelector('.account-sidebar .profile-name');
                                    const sideEmail = document.querySelector('.account-sidebar .profile-email');
                                    const sideImg = document.querySelector('#account-page .profile-image img');
                                    if (sideName) sideName.textContent = display || 'My Account';
                                    if (sideEmail) sideEmail.textContent = user?.email || sideEmail.textContent;
                                    if (sideImg) sideImg.src = avatarUrl || sideImg.src || pick();
                                    // Populate profile form if present
                                    const firstInput = document.getElementById('firstName');
                                    const lastInput = document.getElementById('lastName');
                                    const emailInput = document.getElementById('email');
                                    const phoneInput = document.getElementById('phone');
                                    const addrInput = document.getElementById('address');
                                    const roleSelect = document.getElementById('userRole');
                                    const p = prof || {};
                                    if (firstInput) firstInput.value = p.first_name || user?.user_metadata?.first_name || '';
                                    if (lastInput) lastInput.value = p.last_name || user?.user_metadata?.last_name || '';
                                    if (emailInput) emailInput.value = p.email || user?.email || '';
                                    if (phoneInput) phoneInput.value = p.phone || user?.user_metadata?.phone || '';
                                    if (addrInput) addrInput.value = p.address || user?.user_metadata?.address || '';
                                    if (roleSelect) {
                                        const r = (p.role || user?.user_metadata?.role || 'customer').toLowerCase();
                                        roleSelect.value = ['customer','business','driver'].includes(r) ? r : 'customer';
                                    }
                                } catch (_) {
                                    if (usernameEl) usernameEl.textContent = 'My Account';
                                    if (avatarEl) avatarEl.src = pick();
                                }
                            })();
                            // Also update header profile avatar if it exists
                            (async () => {
                                const headerAvatar = document.querySelector('.user-actions .user-profile .avatar');
                                if (!headerAvatar) return;
                                try {
                                    const mod = await import('./js/supabase.js');
                                    const { supabase } = mod;
                                    const { data } = await supabase.auth.getUser();
                                    const user = data?.user;
                                    headerAvatar.src = user?.user_metadata?.avatar_url || pick();
                                } catch { headerAvatar.src = pick(); }
                            })();
          }
      }

            // Login handling is implemented above using Supabase; avoid double-binding here.

            const signupForm = $('#signup-modal .signup-form');
            signupForm?.addEventListener('submit', async e => {
                e.preventDefault();
                try {
                    const role = $('#signupRole')?.value || 'customer';
                    const firstName = $('#signupFirstName')?.value?.trim();
                    const lastName = $('#signupLastName')?.value?.trim();
                    const email = $('#signupEmail')?.value?.trim();
                    const phone = $('#signupPhone')?.value?.trim();
                    const address = $('#signupAddress')?.value?.trim();
                    const password = $('#signupPassword')?.value || '';
                    const confirm = $('#signupConfirmPassword')?.value || '';
                    const agreed = $('#agreeTerms')?.checked;

                    if (!agreed) return notify('Please agree to Terms and Privacy Policy', 'error');
                    if (!email || !password) return notify('Email and password are required', 'error');
                    if (password.length < 6) return notify('Password must be at least 6 characters', 'error');
                    if (password !== confirm) return notify('Passwords do not match', 'error');

                    // Lazy-load supabase helpers
                    const mod = await import('./js/supabase.js');
                    const { signUpWithProfile } = mod;

                    const { needsConfirmation } = await signUpWithProfile({
                        email,
                        password,
                        firstName,
                        lastName,
                        phone,
                        address,
                        role,
                    });

                    hideModal('signup-modal');
                    if (needsConfirmation) {
                        notify('Check your email to confirm your account before logging in.', 'info');
                    } else {
                        notify('Account created. You can log in now.', 'success');
                        showModal('login-modal');
                    }
                } catch (err) {
                    console.error(err);
                    const msg = err?.message || 'Sign up failed';
                    notify(msg, 'error');
                }
            });

      // Initial auth check
      const initialRole = sessionStorage.getItem('zippybook.role');
      updateAccountMenuForAuthState(!!initialRole);

            // Profile form submit -> save to Supabase
            (function wireProfileForm() {
                const form = document.querySelector('#profile-section .profile-form');
                if (!form) return;
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        const firstName = document.getElementById('firstName')?.value?.trim() || '';
                        const lastName = document.getElementById('lastName')?.value?.trim() || '';
                        const email = document.getElementById('email')?.value?.trim() || '';
                        const phone = document.getElementById('phone')?.value?.trim() || '';
                        const address = document.getElementById('address')?.value?.trim() || '';
                        const role = document.getElementById('userRole')?.value || 'customer';

                        const mod = await import('./js/supabase.js');
                        const { upsertCurrentProfile, updateAuthUserMetadata } = mod;

                        await upsertCurrentProfile({
                            email,
                            first_name: firstName,
                            last_name: lastName,
                            phone,
                            address,
                            role
                        });

                        await updateAuthUserMetadata({
                            first_name: firstName,
                            last_name: lastName,
                            phone,
                            address,
                            role
                        });

                        notify('Profile saved successfully', 'success');

                        const sideName = document.querySelector('.account-sidebar .profile-name');
                        const sideEmail = document.querySelector('.account-sidebar .profile-email');
                        const display = `${firstName} ${lastName}`.trim() || email || 'My Account';
                        if (sideName) sideName.textContent = display;
                        if (sideEmail && email) sideEmail.textContent = email;
                        const usernameEl = accountDropdown?.querySelector('.username');
                        if (usernameEl) usernameEl.textContent = display;
                    } catch (err) {
                        console.error(err);
                        notify(err?.message || 'Failed to save profile', 'error');
                    }
                });
            })();

            // Wire avatar upload in My Account sidebar
            (function wireAccountAvatarUpload() {
                const container = document.getElementById('account-page');
                if (!container) return;
                const img = container.querySelector('.profile-image img');
                const btn = container.querySelector('.edit-profile-pic');
                const input = document.getElementById('account-avatar-input');
                if (!img || !btn || !input) return;
                const trigger = () => input.click();
                img.style.cursor = 'pointer';
                img.title = 'Click to change photo';
                img.addEventListener('click', trigger);
                btn.addEventListener('click', (e) => { e.preventDefault(); trigger(); });
                input.addEventListener('change', async (e) => {
                    const file = e.target && e.target.files && e.target.files[0];
                    if (!file) return;
                    if (!file.type?.startsWith('image/')) return notify('Please select an image file', 'error');
                    const original = img.src;
                    img.style.opacity = '0.6';
                    btn.disabled = true;
                    try {
                        const mod = await import('./js/supabase.js');
                        const { uploadProfileImage, updateProfileAvatar } = mod;
                        const url = await uploadProfileImage(file);
                        await updateProfileAvatar(url);
                        // Update UI: sidebar + nav avatar
                        img.src = url;
                        const navAvatar = document.querySelector('#accountDropdown .avatar-small');
                        if (navAvatar) navAvatar.src = url;
                        const headerAvatar = document.querySelector('.user-actions .user-profile .avatar');
                        if (headerAvatar) headerAvatar.src = url;
                        notify('Profile image updated', 'success');
                    } catch (err) {
                        console.error(err);
                        img.src = original;
                        notify(err?.message || 'Failed to upload image', 'error');
                    } finally {
                        img.style.opacity = '1';
                        btn.disabled = false;
                        input.value = '';
                    }
                });
            })();

      // Account section nav
      $$('.account-nav-link').forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          const section = link.dataset.section;
          $$('.account-nav-link').forEach(l => l.classList.toggle('active', l === link));
          $$('.account-section').forEach(s => s.classList.toggle('active', s.id === `${section}-section`));
        });
      });

      // Bookings tabs
      $$('#bookings-page .tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          $$('#bookings-page .tab-btn').forEach(b => b.classList.toggle('active', b === btn));
          $$('#bookings-page .tab-content').forEach(c => c.classList.toggle('active', c.id === `${tab}-bookings`));
        });
      });
      // Empty-state Explore button
      $('#upcoming-bookings .empty-state .btn')?.addEventListener('click', () => {
        goToPage('explore'); history.pushState({ page: 'explore' }, '', '#explore');
      });

      // Explore: view toggle
      $$('#explore-page .map-view-toggle .btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const view = btn.dataset.view;
          $$('#explore-page .map-view-toggle .btn').forEach(b => b.classList.toggle('active', b === btn));
                    const listEl = $('#explore-page .list-view');
                    const mapEl = $('#explore-page .map-view');
                    listEl?.classList.toggle('active', view === 'list');
                    mapEl?.classList.toggle('active', view === 'map');
                    if (view === 'map' && window.google?.maps && typeof exploreMap?.getCenter === 'function') {
                        const current = exploreMap.getCenter();
                        window.google.maps.event.trigger(exploreMap, 'resize');
                        if (userLatLng) {
                            exploreMap.setCenter(userLatLng);
                            exploreMap.setZoom(14);
                        } else if (current) {
                            exploreMap.setCenter(current);
                        }
                    }
        });
      });

            // Crypto dropdown
            $('#crypto-dropdown-btn')?.addEventListener('click', () => {
                const menu = $('#crypto-submenu');
                menu?.classList.toggle('active');
            });

      // Add Location modal
      $$('.add-location-btn').forEach(btn => btn.addEventListener('click', () => showModal('add-location-modal')));
      $('#cancel-add-location')?.addEventListener('click', () => hideModal('add-location-modal'));
      $('#add-location-modal .add-location-form')?.addEventListener('submit', e => {
        e.preventDefault();
        const name = $('#locationName')?.value?.trim() || 'Location';
        const address = $('#locationAddress')?.value?.trim() || '';
        const list = $('#saved-locations-section .saved-location-list');
        if (list) {
          const el = document.createElement('div');
          el.className = 'saved-location-item';
          el.innerHTML = `
            <div class="location-icon"><i class="fas fa-map-marker-alt"></i></div>
            <div class="location-details"><h4>${name}</h4><p>${address}</p></div>
            <div class="location-actions">
              <button class="btn btn-outline btn-sm edit-location"><i class="fas fa-edit"></i></button>
              <button class="btn btn-outline btn-sm delete-location"><i class="fas fa-trash"></i></button>
            </div>`;
          list.appendChild(el);
        }
        hideModal('add-location-modal');
        notify('Location saved', 'success');
      });

      // Google Maps + Places integration
      function waitForGoogle(maxMs = 15000) {
        return new Promise((resolve, reject) => {
          const start = Date.now();
          (function check() {
            if (window.google?.maps && window.google?.maps.places) return resolve();
            if (Date.now() - start > maxMs) return reject(new Error('Google Maps failed to load'));
            setTimeout(check, 100);
          })();
        });
      }
      async function initMaps() {
        try {
          await waitForGoogle();
          const defaultCenter = { lat: 5.6037, lng: -0.1870 }; // Accra
          // Nearby map
          const nearEl = document.getElementById('map-container');
                                        nearMap = nearEl ? new google.maps.Map(nearEl, { center: defaultCenter, zoom: 12, gestureHandling: 'greedy' }) : null;
          // Explore map
          const exploreEl = document.getElementById('explore-map');
                    exploreMap = exploreEl ? new google.maps.Map(exploreEl, { center: defaultCenter, zoom: 12, gestureHandling: 'greedy' }) : null;
          // Add-location preview
          const previewEl = document.getElementById('location-map-preview');
                    previewMap = previewEl ? new google.maps.Map(previewEl, { center: defaultCenter, zoom: 14, gestureHandling: 'greedy' }) : null;

                    // Expose maps for other modules if needed
                    try { window.zippyMaps = { nearMap, exploreMap, previewMap }; } catch (_) {}

                    // Track and pin user's location on maps
                    const myMarkers = { near: null, explore: null };
                    function setMyLocationMarker(map, key, latLng, recenter = true) {
                        if (!map) return;
                        if (!myMarkers[key]) {
                            myMarkers[key] = new google.maps.Marker({
                                position: latLng,
                                map,
                                title: 'You are here',
                                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#10b981', fillOpacity: 1, strokeColor: '#ffffff', strokeWeight: 2 }
                            });
                        } else {
                            myMarkers[key].setPosition(latLng);
                        }
                        if (recenter) { map.setCenter(latLng); map.setZoom(14); }
                    }
                    function reverseGeocode(latLng) {
                        return new Promise((resolve, reject) => {
                            const geocoder = new google.maps.Geocoder();
                            geocoder.geocode({ location: latLng }, (results, status) => {
                                if (status === 'OK') resolve(results || []); else reject(status);
                            });
                        });
                    }
                    async function applyUserLocation(latLng, recenter = true, shouldNotify = true) {
                        userLatLng = latLng;
                        try { if (window.app) window.app.userLocation = latLng; } catch {}
                        setMyLocationMarker(nearMap, 'near', latLng, recenter);
                        setMyLocationMarker(exploreMap, 'explore', latLng, false);
                        if (previewMap) previewMap.setCenter(latLng);
                        try {
                            const results = await reverseGeocode(latLng);
                            if (results?.[0]?.formatted_address) {
                                const locInput = document.getElementById('location-input');
                                if (locInput) locInput.value = results[0].formatted_address;
                            }
                        } catch {}
                        saveLastLocation(latLng);
                        if (shouldNotify) notify('Location updated', 'success');
                        try { window.dispatchEvent(new CustomEvent('user-location-changed', { detail: latLng })); } catch {}
                    }

                    // Popular Near You markers on nearMap
                    let popularMarkers = [];
                    let popularInfo = null;
                    function clearPopularMarkers() {
                        popularMarkers.forEach(m => m.setMap && m.setMap(null));
                        popularMarkers = [];
                    }
                    async function setPopularMarkers(items = []) {
                        if (!nearMap || !window.google?.maps) return;
                        clearPopularMarkers();
                        if (!items || !items.length) return;
                        if (!popularInfo) popularInfo = new google.maps.InfoWindow();
                        try {
                            const { ensureCoordinatesForAll } = await import('./js/location-utils.js');
                            await ensureCoordinatesForAll(items);
                        } catch (_) {}
                        const bounds = new google.maps.LatLngBounds();
                        items.forEach(item => {
                            const coords = item.coordinates;
                            if (!coords || typeof coords.lat !== 'number' || typeof coords.lng !== 'number') return;
                            const marker = new google.maps.Marker({
                                position: coords,
                                map: nearMap,
                                title: item.name || 'Business',
                                icon: {
                                    url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
                                }
                            });
                            marker.addListener('click', () => {
                                const name = (item.name || 'Business');
                                const cat = (item.category || item.displayCategory || '');
                                const dist = typeof item.__distance === 'number' ? `${item.__distance.toFixed(1)} km away` : '';
                                const html = `
                                    <div style="max-width:220px">
                                        <div style="font-weight:600;margin-bottom:2px">${name}</div>
                                        ${cat ? `<div style="color:#64748b;font-size:.85rem;margin-bottom:4px">${cat}</div>` : ''}
                                        ${dist ? `<div style="color:#0f766e;font-size:.85rem"><i class='fas fa-route'></i> ${dist}</div>` : ''}
                                        <div style="margin-top:8px;display:flex;gap:8px">
                                            <button id="popular-marker-view" style="padding:6px 10px;border:1px solid #e2e8f0;border-radius:6px;background:#fff;cursor:pointer">View</button>
                                        </div>
                                    </div>`;
                                popularInfo.setContent(html);
                                popularInfo.open({ map: nearMap, anchor: marker });
                                // Delegate button click after DOM paints
                                google.maps.event.addListenerOnce(popularInfo, 'domready', () => {
                                    const btn = document.getElementById('popular-marker-view');
                                    if (btn) btn.addEventListener('click', () => {
                                        if (window.featuredBusinessesInstance?.showBusinessModal) {
                                            window.featuredBusinessesInstance.showBusinessModal(item);
                                        }
                                    });
                                });
                            });
                            popularMarkers.push(marker);
                            bounds.extend(marker.getPosition());
                        });
                        // Include user location in bounds for context
                        if (userLatLng) bounds.extend(new google.maps.LatLng(userLatLng.lat, userLatLng.lng));
                        if (popularMarkers.length > 0) {
                            nearMap.fitBounds(bounds);
                        }
                    }

                    // Listen for items from PopularNearYou module
                    window.addEventListener('popular-near-you:items', (e) => {
                        const items = e?.detail?.items || [];
                        setPopularMarkers(items);
                    });

          // Places Autocomplete
                    const locInput = document.getElementById('location-input');
          if (locInput) {
            const ac = new google.maps.places.Autocomplete(locInput);
            ac.addListener('place_changed', () => {
              const place = ac.getPlace();
              const loc = place?.geometry?.location;
              if (loc) {
                nearMap?.setCenter(loc);
                exploreMap?.setCenter(loc);
                previewMap?.setCenter(loc);
              }
            });
          }
          const addrInput = document.getElementById('locationAddress');
          if (addrInput) new google.maps.places.Autocomplete(addrInput);
          const signupAddr = document.getElementById('signupAddress');
          if (signupAddr) new google.maps.places.Autocomplete(signupAddr);

          // Current location
                    document.getElementById('current-location-btn')?.addEventListener('click', () => {
                        if (!navigator.geolocation) return notify('Geolocation not supported', 'error');
                        navigator.geolocation.getCurrentPosition(
                            pos => applyUserLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude }, true),
                            () => notify('Unable to get current location', 'error')
                        );
                    });

                    // Use last-known location immediately, then request fresh location
                    const last = readLastLocation();
                    if (last) applyUserLocation(last, true, false);
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            pos => applyUserLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude }, true, true),
                            () => {/* silent failure to avoid intrusive errors on load */},
                            { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                        );
                    }

                                        // If popular items already loaded before map, render them now
                                        if (window.popularNearYou?.items?.length) {
                                                setPopularMarkers(window.popularNearYou.items);
                                        }
        } catch (err) {
          console.warn(err);
        }
      }
      initMaps();

      // Footer nav shortcuts
      document.getElementById('footer-explore-link')?.addEventListener('click', (e) => {
        e.preventDefault();
        goToPage('explore');
        history.pushState({ page: 'explore' }, '', '#explore');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    </script>
</body>
</html>
